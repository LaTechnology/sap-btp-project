sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Input","sap/m/MessageToast","sap/ui/richtexteditor/RichTextEditor","sap/m/MessageBox","sap/ui/richtexteditor/library","sap/ui/model/json/JSONModel"],function(e,t,o,i,n,s,a){"use strict";return e.extend("ns.propose.controller.ProposalForm",{_sectionTitle:1,_mainSectionId:1,_SubSectionId:1,_mainSections:[],_subsection:1,_subSections:[],_imagecount:1,_inputString:"",_subSectionCounter:1,_sectionCounters:{},_table:1,_tableitem:1,textitem:1,onInit:function(){this._tableitem=1;this._sectionTitle=1;this._mainSectionId=1;this._mainSections=[1];this._subsection1=1;this._subsection=[1];this._SubSectionId=1;this._imagecount=1;this._subSectionCounter=1;this._sectionCounters={};this._setInitialSectionTitle();this._table=1;this.textitem=1},_setInitialSectionTitle:function(){var e=this;var t=this.getView().byId("wizard");var o=t.getProgressStep();var i=t.getSteps();var n=i.indexOf(o);var s="Section-"+this._sectionTitle++;this._titleSubInputCounter=0;this._titleSubInputCounter++;if(n===-1){n++}this._SubSectionId=s;console.log("Current Step Index: "+n);console.log("Generated Input ID: "+s);var a=new sap.m.VBox;var r=new sap.m.Label({text:s,design:"Bold"});var c=new sap.m.Input({id:s,placeholder:"Enter your title...",width:"80%"});a.addItem(r);a.addItem(c);var l=new sap.m.ColumnListItem({cells:[a]});var d=e.getView().byId("idFrame"+n);console.log(d);if(d){d.addItem(l);c.setVisible(true);this._mainSections.push(s);console.log("Section added successfully.")}else{console.error("idFrame not found for step "+n)}},onAddRowTextArea:function(){var e=this;var t=e.getView().byId("wizard");var o=t.getProgressStep();var i=t.getSteps().indexOf(o);var n="Text-"+e.textitem++;console.log(n);var s=e.getView().byId("idFrame"+i);if(s){var a=new sap.ui.richtexteditor.RichTextEditor({id:n,width:"100%",editorType:sap.ui.richtexteditor.EditorType.TinyMCE4,customToolbar:true,showGroupFont:true,showGroupLink:true,showGroupInsert:true,showGroupClipboard:true,showGroupUndo:true,showGroupStructure:true,showGroupTextAlign:true,showGroupFontStyle:true}).addStyleClass("myRichTextEditor");var r=new sap.m.ColumnListItem({cells:[a]});s.addItem(r);a.attachChange(function(t){var o=a.getValue();var i=btoa(o);if(e._addingTextArea){e._mainsectiontext1=i;console.log(e._mainsectiontext)}else if(!e._addingTextArea){e._subsectiontext=i;console.log(e._subsectiontext)}});console.log("Rich Text Area added successfully")}else{console.error("idFrame not found for step "+i)}},onSubSection:function(){var e=this;var t=e.getView().byId("wizard");var o=t.getProgressStep();var i=t.getSteps().indexOf(o);var n=e.getView().byId("idFrame"+i);e._addingImageForSubSection=true;e._addingTextArea=true;if(i>=0){console.log("current Step  :"+i);if(!this._sectionCounters[i]){this._sectionCounters[i]=1}else{this._sectionCounters[i]++}var s="SubSection_"+(i+1)+"."+this._sectionCounters[i];console.log(s);var a=new sap.m.VBox;var r=new sap.m.Label({text:s,design:"Bold"});var c=new sap.m.Input({id:s,placeholder:"Enter your title...",width:"80%"});if(n){a.addItem(r);a.addItem(c);var l=new sap.m.ColumnListItem({cells:[a]});n.addItem(l);c.setVisible(true);this._subSections.push(s)}else{console.error("idFrame not found for SubSection")}}console.log("moving to the next step");var d=s},onSave:function(){var e=this;var t=e.getView().byId("wizard");this.saveMainSection().then(function(t){e.saveSubSection(t)}).catch(function(e){console.error("Error saving data:",e)})},saveMainSection:function(){var e=this.getView().getModel();var t=[];return Promise.all(this._mainSections.map(i=>{var n=sap.ui.getCore().byId(i);if(n){var s={id:"MAIN_0"+this._mainSectionId++,mainSectiontitle:n.getValue(),imagearea:this._inputString||null,textarea:this._subsectiontext||null};console.log(s);return new Promise(function(i,n){e.create("/MainSection",s,{method:"POST",success:function(){o.show("Main- Section Added Successfully");t.push(s.id);i();console.log("Section saved to DB")},error:function(e){n(e)}})})}})).then(function(){return t})},saveSubSection:function(e){var t=this.getView().getModel();var i=[];return Promise.all(this._subSections.map((n,s)=>{var a=sap.ui.getCore().byId(n);if(a){var r=e[s];var c={id:"SUB_0"+this._subSectionCounter++,subSectiontitle:a.getValue()||null,parentSection_id:r,imagearea:this._inputString||null,textarea:this._mainsectiontext1||null};console.log(c);return new Promise(function(e,n){t.create("/SubSection",c,{method:"POST",success:function(t,n){console.log("Success Response:",n);var s=n.headers["sap-message"].split(":")[1].trim();i.push(s);o.show("Sub Section Added Successfully");e();console.log("Sub Section has been added")},error:function(e){console.error("Error Response:",e);n(e)}})})}})).then(function(){return i}).catch(function(e){console.error("Error saving Sub Sections:",e)})},addSectionLabel:function(e,t){var o=parseInt(e.replace("Step ",""));var i="Section_"+(o<10?"0":"")+o;console.log(i);var n=new sap.m.VBox;var s=new sap.m.Label({text:"Section: "+i,design:"Bold"});var a=new sap.m.Input({id:i,placeholder:"Enter your title...",width:"80%"});n.addItem(s);n.addItem(a);var r=new sap.m.ColumnListItem({cells:[n]});var c="idFrame"+o;var l=t.byId(c);if(l){l.addItem(r);a.setVisible(true);this._mainSections.push(i)}},onStepChanged:function(e){var t=e.getSource();var o=t.getProgressStep();if(o>=11){console.error("Error: Current step exceeds the limit of 10")}else{this._setInitialSectionTitle()}},onContinue:function(){this.onNext()},onNext:function(){var e=this.getView().byId("wizard");e.nextStep()},onComplete:function(){var e=this;n.show("Do you need to complete the steps?",{icon:n.Icon.QUESTION,title:"Complete Steps",actions:[n.Action.YES,n.Action.NO],onClose:function(e){if(e===n.Action.YES){console.log("clicked yes")}else{console.log("clicked no")}}})},onUploadComplete:function(e){var t=e.getParameter("response");n.success("File upload complete. Response: "+t)},onTypeMissmatch:function(e){n.error("Selected file type does not match the allowed file types")},onFileSizeExceed:function(e){n.error("File size exceeds the maximum allowed size")},onAddImage:function(){var e=this;var t=e.getView().byId("wizard");var o=t.getProgressStep();var i=t.getSteps().indexOf(o);var n=e.getView().byId("idFrame"+i);var s="Image"+this._imagecount++;console.log(s);var a=new sap.m.VBox;var r=new sap.m.Label({text:s,design:"Bold"});var c=new sap.ui.unified.FileUploader({id:s,placeholder:"Upload Image",width:"80%",fileType:"png,jpg,jpeg",change:e.onChangeDP.bind(e),uploadComplete:e.onUploadComplete.bind(e),typeMissmatch:e.onTypeMissmatch.bind(e),fileSizeExceed:e.onFileSizeExceed.bind(e)});var n=e.getView().byId("idFrame"+i);if(n){a.addItem(r);a.addItem(c);var l=new sap.m.ColumnListItem({cells:[a]});n.addItem(l);c.setVisible(true);if(e._addingImageForSubSection){e._subSections.push(s);console.log("Image added successfully to SubSection")}else{e._mainSections.push(s);console.log("Image added successfully to Main Section")}}else{console.error("idFrame not found for SubSection")}},onChangeDP:function(e){var t=this;var o=new Image;var i=e.getParameter("files")[0];var n=new FileReader;n.readAsDataURL(i);n.onload=function(){var e=n.result;var i=e;console.log(i);this.input=i;var s=["data:image/png;base64,","data:text/plain;base64,","data:image/jpeg;base64,","data:audio/mpeg;base64,","data:application/vnd.ms-excel;base64,","data:video/mp4;base64,"];var a="";var r=new RegExp(s.join("|"),"gi");var c=i.replace(r,a);console.log(c);t._inputString=c;var l=c;var d=i;t.byId("imagePreview").setSrc(d);o.onload=function(){if(this.width+this.height===0){t.dpImage="";sap.m.MessageBox.error("Invalid Image!")}}};n.onerror=function(e){};this.pDialog.then(e=>e.close())},onAddTable:function(e){var t=this;var o=t.getView().byId("wizard");var i=o.getProgressStep();var n=o.getSteps().indexOf(i);var s="Table-"+t.tableitem++;var a=t.getView().byId("idFrame"+n);if(a){var r=new sap.ui.richtexteditor.RichTextEditor({id:s,width:"100%",editorType:sap.ui.richtexteditor.EditorType.bIsTinyMCE5,customToolbar:false,showGroupFont:true,showGroupLink:true,showGroupInsert:true,showGroupClipboard:true,showGroupUndo:true,showGroupStructure:true,showGroupTextAlign:true,showGroupFontStyle:true,ready:function(){e?this.addButtonGroup("table"):this.addButtonGroup("table")}}).addStyleClass("myRichTextEditor");var c=new sap.m.ColumnListItem({cells:[r]});a.addItem(c);var l=t._mainSections.some(function(e){return e.richTextEditor===r});if(t._addingTextArea){t._subSections.push({id:s,richTextEditor:r});r.attachChange(function(e){var o=r.getValue();var i=btoa(o);t._subsectiontext=i;console.log(t._subsectiontext)});console.log("Rich Text Area added successfully to SubSection")}else{t._mainSections.push({id:s,richTextEditor:r});r.attachChange(function(e){var o=r.getValue();var i=btoa(o);t._mainsectiontext=i;console.log(t._mainsectiontext)});console.log("Rich Text Area added successfully to Main Section")}}else{console.error("idFrame not found for step "+n)}}})});